name: Build and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        #os: [ubuntu-latest, windows-latest]
        os: [ubuntu-latest]
        build_type: [Release, Debug]

    steps:
      - uses: actions/checkout@v4

      - name: Install gcc 14 and g++ 14
        if : matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y g++-14 gcc-14

      - name: Set Default Compilers
        if : matrix.os == 'ubuntu-latest'
        run: >
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100 &&
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 &&
          sudo update-alternatives --set g++ /usr/bin/g++-14 &&
          sudo update-alternatives --set gcc /usr/bin/gcc-14
      - name: Check Compiler Versions
        if : matrix.os == 'ubuntu-latest'
        run: |
          gcc -v &&
          g++ -v

      - name: Configure CMake
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{matrix.build_type}}

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config ${{matrix.build_type}}

#      - name: Run tests
#        working-directory: ${{github.workspace}}/build
#        run: ctest --output-on-failure

      - name: Clone and build fastchess
        run: git clone https://github.com/Disservin/fastchess.git && cd fastchess && make -j

      - name: Get the previous version of chess engine
        run: |
          git clone --depth 1 --branch $(git ls-remote --tags --sort="v:refname" https://github.com/leofracca/chess-engine.git | tail -n1 | sed 's/.*\///') https://github.com/leofracca/chess-engine.git
          cd chess-engine
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make
          cd ../..

      - name: Download and unzip opening book
        run: |
          curl -L -o 8moves_v3.pgn.zip https://github.com/official-stockfish/books/raw/refs/heads/master/8moves_v3.pgn.zip
          unzip 8moves_v3.pgn.zip

      - name: Run matches between current and previous version
        run: |
          ./fastchess/fastchess \
          -engine cmd=./build/chess-engine name="New version" \
          -engine cmd=./chess-engine/build/chess-engine name="Current version" \
          -pgnout file="games.pgn" \
          -openings file=../8moves_v3.pgn format=pgn order=random \
          -each tc=120+0.08 \
          -rounds 1000 -repeat \
          -concurrency 8 \
          -recover \
          -sprt elo0=0 elo1=10 alpha=0.05 beta=0.1
        continue-on-error: true
